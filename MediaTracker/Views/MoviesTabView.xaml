<UserControl x:Class="MediaTracker.Views.MoviesTabView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:converters="clr-namespace:MediaTracker.Converters"
             mc:Ignorable="d"
             d:DesignHeight="500" d:DesignWidth="700"
             Background="#ECECEC">

    <UserControl.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converters:NullableIntConverter x:Key="NullableIntConverter"/>
        <converters:MovieDateTupleConverter x:Key="MovieDateTupleConverter"/>
        <converters:IntToVisibilityConverter x:Key="IntToVisibilityConverter"/>
        <converters:NullOrEmptyToSeparatorConverter x:Key="NullOrEmptyToSeparatorConverter"/>
        <!-- Shadow effect for modern cards -->
        <DropShadowEffect x:Key="CardShadow" Color="#333" Opacity="0.1" BlurRadius="12"/>
    </UserControl.Resources>

    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- ADD MOVIE CARD -->
        <Border Grid.Row="0"
        Padding="16"
        Margin="0,0,0,24"
        CornerRadius="12"
        Background="#F5F5F5"
        Effect="{StaticResource CardShadow}">
            <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">

                    <!-- Title -->
                    <StackPanel Margin="0,0,12,0">
                        <TextBlock Text="Title:" FontSize="12" Foreground="#555"/>
                        <TextBox Width="180" Height="36" Padding="4"
                         Text="{Binding NewTitle}" />
                    </StackPanel>

                    <!-- Year -->
                    <StackPanel Margin="0,0,12,0">
                        <TextBlock Text="Year:" FontSize="12" Foreground="#555"/>
                        <TextBox Width="60" Height="36" Padding="4"
                         Text="{Binding NewYear}" />
                    </StackPanel>

                    <!-- Big Franchise -->
                    <StackPanel Margin="0,0,12,0">
                        <TextBlock Text="Big Franchise:" FontSize="12" Foreground="#555"/>
                        <TextBox Width="120" Height="36" Padding="4"
                         Text="{Binding NewBigFranchise}" />
                    </StackPanel>

                    <!-- Franchise -->
                    <StackPanel Margin="0,0,12,0">
                        <TextBlock Text="Franchise:" FontSize="12" Foreground="#555"/>
                        <TextBox Width="120" Height="36" Padding="4"
                         Text="{Binding NewFranchise}" />
                    </StackPanel>

                    <!-- Franchise Number -->
                    <StackPanel Margin="0,0,12,0">
                        <TextBlock Text="Franchise #:" FontSize="12" Foreground="#555"/>
                        <TextBox Width="50" Height="36" Padding="4"
                         Text="{Binding NewFranchiseNumber}" />
                    </StackPanel>

                    <!-- Add Button -->
                    <Button Content="Add" Height="36" Padding="20,6" Background="#4CAF50" Foreground="White"
                    Command="{Binding AddMovieCommand}"/>
                </StackPanel>
            </ScrollViewer>
        </Border>



        <!-- MOVIE LIST -->
        <ScrollViewer Grid.Row="1">
            <ItemsControl ItemsSource="{Binding MoviesCollection}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel Orientation="Horizontal" ItemWidth="300" ItemHeight="Auto" Margin="0" />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>

                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <!-- Movie card with franchise color -->
                        <Border Width="280"
                                Margin="0,0,16,16"
                                Padding="12"
                                CornerRadius="12"
                                Background="#F0F0F0"
                                Effect="{StaticResource CardShadow}">
                            <Border.InputBindings>
                                <MouseBinding Gesture="LeftClick"
                                              Command="{Binding DataContext.ToggleExpandCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                              CommandParameter="{Binding}"/>
                            </Border.InputBindings>

                            <StackPanel>
                                <!-- HEADER -->
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <StackPanel>
                                        <!-- DISPLAY MODE -->
                                        <StackPanel Orientation="Vertical" Margin="0,4,0,0"
                                                    Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=False}">

                                            <!-- Title -->
                                            <TextBlock Text="{Binding Title}"
                                                       FontSize="16"
                                                       FontWeight="Bold"
                                                       Foreground="#222"
                                                       TextWrapping="Wrap"
                                                       MaxWidth="260"/>

                                            <!-- Info line -->
                                            <TextBlock Foreground="#555" TextWrapping="Wrap" MaxWidth="260">
                                            <TextBlock Text="{Binding DisplayMeta}"
                                                       Foreground="#555"
                                                       TextWrapping="Wrap"/>
                                            </TextBlock>

                                        </StackPanel>


                                        <!-- EDIT MODE -->
                                        <StackPanel Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <!-- Title -->
                                            <TextBox Text="{Binding Title}"
                                                     FontSize="15"
                                                     Padding="4"
                                                     Margin="0,0,0,6"
                                                     MaxWidth="200"/>

                                            <!-- Big Franchise -->
                                            <TextBox Text="{Binding BigFranchise}"
                                                     Padding="4"
                                                     Margin="0,0,0,6"/>

                                            <!-- Year / Franchise / Franchise Number -->
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="60"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="50"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBox Grid.Column="0" Text="{Binding Year}" Margin="0,0,6,0"/>
                                                <!-- Franchise -->
                                                <TextBox Grid.Column="1"
                                                         Text="{Binding Franchise, UpdateSourceTrigger=PropertyChanged, TargetNullValue=''}"
                                                         Margin="0,0,6,0"/>

                                                <!-- Franchise Number -->
                                                <TextBox Grid.Column="2"
                                                         Text="{Binding FranchiseNumber, UpdateSourceTrigger=PropertyChanged, TargetNullValue=''}"/>
                                            </Grid>
                                        </StackPanel>


                                    </StackPanel>


                                    <!-- ACTION BUTTONS -->
                                    <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right">
                                        <!-- Edit -->
                                        <Button Width="28" Height="28" FontFamily="Segoe MDL2 Assets" FontSize="14" Content="" ToolTip="Edit"
                                                Command="{Binding DataContext.EditMovieCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding}"
                                                Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=False}"
                                                Background="#EEE" Foreground="#333" BorderThickness="0" Margin="0,0,4,0"/>
                                        <!-- Save -->
                                        <Button Width="28" Height="28" FontFamily="Segoe MDL2 Assets" FontSize="14" Content="" ToolTip="Save"
                                                Command="{Binding DataContext.SaveMovieCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding}"
                                                Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}}"
                                                Background="#4CAF50" Foreground="White" BorderThickness="0" Margin="0,0,4,0"/>
                                        <!-- Delete -->
                                        <Button Width="28" Height="28" FontFamily="Segoe MDL2 Assets" FontSize="14" Content="" ToolTip="Delete"
                                                Command="{Binding DataContext.RemoveMovieCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding}"
                                                Background="#F44336" Foreground="White" BorderThickness="0"/>
                                    </StackPanel>
                                </Grid>

                                <!-- NOTE -->
                                <Border Margin="0,10,0,0" Padding="10" Background="#DCDCDC" CornerRadius="8">
                                    <Grid>
                                        <TextBlock Text="{Binding Note}" TextWrapping="Wrap" Foreground="#333"
                                                   Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=False}"/>
                                        <TextBox Text="{Binding Note}" AcceptsReturn="True" TextWrapping="Wrap" Height="60"
                                                 Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=True}"
                                                 Padding="6"/>
                                    </Grid>
                                </Border>

                                <!-- WATCH DATES -->
                                <StackPanel Margin="0,10,0,0"
                                            Visibility="{Binding IsExpanded, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                                        <TextBox Width="120" Text="{Binding DataContext.NewWatchDate, RelativeSource={RelativeSource AncestorType=UserControl}}" Height="28" Padding="4"/>
                                        <Button Content="Add" Margin="6,0,0,0"
                                                Command="{Binding DataContext.AddWatchDateCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding}" Height="28" Padding="12,0" Background="#4CAF50" Foreground="White"/>
                                    </StackPanel>

                                    <ItemsControl ItemsSource="{Binding WatchDates}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel/>
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>

                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Padding="6,2" Margin="0,0,6,6" Background="#E9ECEF" CornerRadius="6">
                                                    <StackPanel Orientation="Horizontal">
                                                        <TextBlock Text="{Binding StringFormat='{}{0:dd/MM/yyyy}'}"/>
                                                        <Button Width="24" Height="24" FontFamily="Segoe MDL2 Assets" FontSize="12" Content=""
                                                                Margin="6,0,0,0"
                                                                Command="{Binding DataContext.RemoveWatchDateCommand, RelativeSource={RelativeSource AncestorType=UserControl}}">
                                                            <Button.CommandParameter>
                                                                <MultiBinding Converter="{StaticResource MovieDateTupleConverter}">
                                                                    <Binding RelativeSource="{RelativeSource AncestorType=ItemsControl}" Path="DataContext"/>
                                                                    <Binding/>
                                                                </MultiBinding>
                                                            </Button.CommandParameter>
                                                        </Button>
                                                    </StackPanel>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>
    </Grid>
</UserControl>
