<UserControl x:Class="MediaTracker.Views.MoviesTabView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:converters="clr-namespace:MediaTracker.Converters"
             xmlns:xctk="http://schemas.xceed.com/wpf/xaml/toolkit"
             mc:Ignorable="d"
             d:DesignHeight="500" d:DesignWidth="700"
             Background="#ECECEC">

    <UserControl.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converters:NullableIntConverter x:Key="NullableIntConverter"/>
        <converters:MovieDateTupleConverter x:Key="MovieDateTupleConverter"/>
        <converters:IntToVisibilityConverter x:Key="IntToVisibilityConverter"/>
        <converters:NullOrEmptyToSeparatorConverter x:Key="NullOrEmptyToSeparatorConverter"/>
        <converters:CollapseArrowConverter x:Key="CollapseArrowConverter"/>
        <converters:ExpandWhileNotEditingConverter x:Key="ExpandWhileNotEditingConverter"/>
        <converters:BoolToTextConverter x:Key="BoolToTextConverter"/>
        <converters:LightBackgroundToForegroundConverter x:Key="LightBackgroundToForegroundConverter"/>

        <!-- Shadow effect for modern cards -->
        <DropShadowEffect x:Key="CardShadow" Color="#333" Opacity="0.1" BlurRadius="12"/>

        <!-- Shadow effect for Edit/Delete/Undo/Save buttons -->
        <DropShadowEffect x:Key="IconShadow" Color="Black" BlurRadius="4" ShadowDepth="0" Opacity="0.45"/>
    </UserControl.Resources>
    

    
    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- ADD MOVIE CARD -->
        <Border Grid.Row="0" Padding="16" Margin="0,0,0,24" CornerRadius="12" Background="#F5F5F5" Effect="{StaticResource CardShadow}">
            <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <!-- Title -->
                    <StackPanel Margin="0,0,12,0">
                        <TextBlock Text="Title:" FontSize="12" Foreground="#555"/>
                        <xctk:WatermarkTextBox Width="180" Height="36" Padding="4" Text="{Binding NewTitle}" Watermark="Title"/>
                    </StackPanel>
                    <!-- Year -->
                    <StackPanel Margin="0,0,12,0">
                        <TextBlock Text="Year:" FontSize="12" Foreground="#555"/>
                        <xctk:WatermarkTextBox Width="60" Height="36" Padding="4" Text="{Binding NewYear}" Watermark="Year"/>
                    </StackPanel>
                    <!-- Saga -->
                    <StackPanel Margin="0,0,12,0">
                        <TextBlock Text="Saga:" FontSize="12" Foreground="#555"/>
                        <xctk:WatermarkTextBox Width="120" Height="36" Padding="4" Text="{Binding NewSaga}" Watermark="Saga"/>
                    </StackPanel>
                    <!-- Franchise -->
                    <StackPanel Margin="0,0,12,0">
                        <TextBlock Text="Franchise:" FontSize="12" Foreground="#555"/>
                        <xctk:WatermarkTextBox Width="120" Height="36" Padding="4" Text="{Binding NewFranchise}" Watermark="Franchise"/>
                    </StackPanel>
                    <!-- Franchise Number -->
                    <StackPanel Margin="0,0,12,0">
                        <TextBlock Text="Franchise #:" Height="16" FontSize="12" Foreground="#555"/>
                        <xctk:WatermarkTextBox Width="60" Height="36" Padding="4" Text="{Binding NewFranchiseNumber}" Watermark="#" />
                    </StackPanel>
                    <!-- Add Button -->
                    <StackPanel Margin="0,0,12,0">
                        <TextBlock Height="16"/>
                        <Button Content="Add" Height="36" Padding="20,6" Background="#4CAF50" Foreground="White" Command="{Binding AddMovieCommand}"/>
                    </StackPanel>
                    
                        <!-- Comments Button -->
                    <StackPanel Margin="0,0,12,0">
                        <TextBlock Height="16"/>
                        <ToggleButton Content="Comments"
                                      Height="36"
                                      Padding="20,6"
                                      Background="#607D8B"
                                      Foreground="White"
                                      IsChecked="{Binding ShowComments}"/>
                    </StackPanel>
                </StackPanel>
            </ScrollViewer>
        </Border>



        <!-- MOVIE LIST -->
        <ScrollViewer Grid.Row="1">
            <ItemsControl ItemsSource="{Binding SagaGroups}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <StackPanel Margin="0,0,0,24">
                            <!-- Saga Header -->
                            <StackPanel Orientation="Horizontal" Cursor="Hand"
                                MouseLeftButtonUp="SagaHeader_Click">
                                <TextBlock Text="{Binding Name}" FontWeight="Bold" FontSize="24"/>
                                <TextBlock Text="{Binding IsCollapsed, Converter={StaticResource CollapseArrowConverter}}" 
                                   Margin="4,8,0,0"/>
                            </StackPanel>

                            <!-- Movies under this Saga -->
                            <ItemsControl ItemsSource="{Binding Movies}" 
                                    Visibility="{Binding IsCollapsed, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=False}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Orientation="Horizontal" ItemWidth="300" ItemHeight="Auto"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>

                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Grid>
                                            <!-- BEGIN: Movie Card -->
                                            <Border Width="280"
                                                    Margin="0,0,16,16"
                                                    Padding="12"
                                                    CornerRadius="12"
                                                    BorderBrush="Black" 
                                                    BorderThickness="1.5"
                                                    Background="{Binding FranchiseBrush}"   
                                                    Effect="{StaticResource CardShadow}"
                                                    MouseLeftButtonUp="MovieCard_Click">
                                                <StackPanel>
                                                    <!-- HEADER -->
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition/>
                                                            <ColumnDefinition Width="Auto"/>
                                                        </Grid.ColumnDefinitions>

                                                        <StackPanel>
                                                            <!-- DISPLAY MODE -->
                                                            <StackPanel Orientation="Vertical" Margin="0,4,0,0"
                                                                        Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=False}">

                                                                <!-- Semi-transparent background for all text -->
                                                                <Border Background="#40FFFFFF" CornerRadius="4" Padding="6" MaxWidth="260">
                                                                    <StackPanel>
                                                                        <!-- Title -->
                                                                        <TextBlock Text="{Binding Title}"
                                                                                   FontSize="16"
                                                                                   FontWeight="Bold"
                                                                                   Foreground="{Binding FranchiseBrush, Converter={StaticResource LightBackgroundToForegroundConverter}}"
                                                                                   TextWrapping="Wrap"/>
                                                                        <!-- Info line -->
                                                                        <TextBlock Text="{Binding DisplayMeta}"
                                                                                   FontSize="12"
                                                                                   Foreground="{Binding FranchiseBrush, Converter={StaticResource LightBackgroundToForegroundConverter}}"
                                                                                   TextWrapping="Wrap"/>
                                                                        <Button Content="{Binding IsExpanded,
                                                                                                  Converter={StaticResource BoolToTextConverter},
                                                                                                  ConverterParameter='Show dates|Hide dates'}"
                                                                                Margin="0,6,0,0"
                                                                                Padding="8,2"
                                                                                FontSize="11"
                                                                                HorizontalAlignment="Left"
                                                                                Command="{Binding DataContext.ToggleExpandCommand,
                                                                                                  RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                                CommandParameter="{Binding}"/>
                                                                    </StackPanel>
                                                                </Border>

                                                            </StackPanel>

                                                            <!-- EDIT MODE -->
                                                            <StackPanel Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}}">
                                                                <!-- Title -->
                                                                <xctk:WatermarkTextBox Text="{Binding Title}"
                                                                 Watermark="Title"
                                                                 FontSize="15"
                                                                 Padding="4"
                                                                 Margin="0,0,0,6"
                                                                 MaxWidth="200"/>

                                                                <!-- Saga -->
                                                                <xctk:WatermarkTextBox Text="{Binding Saga}"
                                                                 Watermark="Saga"
                                                                 Padding="4"
                                                                 Margin="0,0,0,6"/>

                                                                <!-- Year / Franchise / Franchise Number -->
                                                                <Grid>
                                                                    <Grid.ColumnDefinitions>
                                                                        <ColumnDefinition Width="60"/>
                                                                        <ColumnDefinition Width="*"/>
                                                                        <ColumnDefinition Width="50"/>
                                                                    </Grid.ColumnDefinitions>

                                                                    <xctk:WatermarkTextBox Grid.Column="0" Text="{Binding Year}" Watermark="Year" Margin="0,0,6,0"/>
                                                                    <xctk:WatermarkTextBox Grid.Column="1"
                                                                     Text="{Binding Franchise, UpdateSourceTrigger=PropertyChanged, TargetNullValue=''}"
                                                                     Watermark="Franchise" Margin="0,0,6,0"/>
                                                                    <xctk:WatermarkTextBox Grid.Column="2"
                                                                     Text="{Binding FranchiseNumber, UpdateSourceTrigger=PropertyChanged, TargetNullValue=''}" Watermark="#"/>
                                                                </Grid>
                                                                <xctk:ColorPicker
                                                                            SelectedColor="{Binding FranchiseColor, Mode=TwoWay}"
                                                                            Margin="0,6,0,6"
                                                                            Width="120"/>
                                                            </StackPanel>
                                                        </StackPanel>
                                                    </Grid>

                                                    <!-- NOTE -->
                                                    <Border Margin="0,10,0,0"
                                                            Padding="10"
                                                            Background="#DCDCDC"
                                                            CornerRadius="8"
                                                            Height="80"
                                                            Visibility="{Binding DataContext.ShowComments,
                                                                         RelativeSource={RelativeSource AncestorType=UserControl},
                                                                         Converter={StaticResource BoolToVisibilityConverter}}">
                                                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                                                            <Grid>
                                                                <TextBlock Text="{Binding Note}"
                                                                           TextWrapping="Wrap"
                                                                           Foreground="#333"
                                                                           Visibility="{Binding IsEditing,
                                                                               Converter={StaticResource BoolToVisibilityConverter},
                                                                               ConverterParameter=False}"/>

                                                                <TextBox Text="{Binding Note}"
                                                                         AcceptsReturn="True"
                                                                         TextWrapping="Wrap"
                                                                         VerticalScrollBarVisibility="Auto"
                                                                         Visibility="{Binding IsEditing,
                                                                             Converter={StaticResource BoolToVisibilityConverter},
                                                                             ConverterParameter=True}"
                                                                         Padding="6"/>
                                                            </Grid>
                                                        </ScrollViewer>
                                                    </Border>

                                                    <!-- WATCH DATES -->
                                                    <StackPanel Margin="0,10,0,0">
                                                        <StackPanel.Visibility>
                                                            <MultiBinding Converter="{StaticResource ExpandWhileNotEditingConverter}">
                                                                <Binding Path="IsExpanded"/>
                                                                <Binding Path="IsEditing"/>
                                                            </MultiBinding>
                                                        </StackPanel.Visibility>
                                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                                                            <TextBox Width="120" Text="{Binding DataContext.NewWatchDate, RelativeSource={RelativeSource AncestorType=UserControl}}" Height="28" Padding="4"/>
                                                            <Button Content="Add" Margin="6,0,0,0"
                                                            Command="{Binding DataContext.AddWatchDateCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                            CommandParameter="{Binding}" Height="28" Padding="12,0" Background="#4CAF50" Foreground="White"/>
                                                        </StackPanel>

                                                        <ItemsControl ItemsSource="{Binding WatchDates}">
                                                            <ItemsControl.ItemsPanel>
                                                                <ItemsPanelTemplate>
                                                                    <WrapPanel/>
                                                                </ItemsPanelTemplate>
                                                            </ItemsControl.ItemsPanel>

                                                            <ItemsControl.ItemTemplate>
                                                                <DataTemplate>
                                                                    <Border Padding="6,2" Margin="0,0,6,6" Background="#E9ECEF" CornerRadius="6">
                                                                        <StackPanel Orientation="Horizontal">
                                                                            <TextBlock Text="{Binding StringFormat='{}{0:dd/MM/yyyy}'}"/>
                                                                            <Button Width="24" Height="24" FontFamily="Segoe MDL2 Assets" FontSize="12" Content=""
                                                                            Margin="6,0,0,0"
                                                                            Command="{Binding DataContext.RemoveWatchDateCommand, RelativeSource={RelativeSource AncestorType=UserControl}}">
                                                                                <Button.CommandParameter>
                                                                                    <MultiBinding Converter="{StaticResource MovieDateTupleConverter}">
                                                                                        <Binding RelativeSource="{RelativeSource AncestorType=ItemsControl}" Path="DataContext"/>
                                                                                        <Binding/>
                                                                                    </MultiBinding>
                                                                                </Button.CommandParameter>
                                                                            </Button>
                                                                        </StackPanel>
                                                                    </Border>
                                                                </DataTemplate>
                                                            </ItemsControl.ItemTemplate>
                                                        </ItemsControl>
                                                    </StackPanel>
                                                </StackPanel>
                                            </Border>
                                            <!-- END: Movie Card -->
                                            <!-- ACTION BUTTONS -->
                                            <StackPanel Orientation="Horizontal"
                                                        HorizontalAlignment="Right"
                                                        VerticalAlignment="Top"
                                                        Margin="0,-14,4,0"
                                                        Visibility="{Binding IsSidePanelOpen, Converter={StaticResource BoolToVisibilityConverter}}">
                                                <Border Background="{Binding FranchiseBrush}" 
                                                        BorderBrush="Black"
                                                        BorderThickness="1"
                                                        CornerRadius="6"
                                                        Padding="4"
                                                        Effect="{StaticResource IconShadow}">
                                                    <StackPanel Orientation="Horizontal">
                                                        <Button Width="28" Height="28" FontFamily="Segoe MDL2 Assets" FontSize="14" Content="" ToolTip="Edit"
                                                                Command="{Binding DataContext.EditMovieCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                CommandParameter="{Binding}"
                                                                Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=False}"
                                                                Background="#2196F3" Foreground="White" BorderBrush="Black" BorderThickness="1.5" Margin="0,0,4,0"
                                                                Effect="{StaticResource IconShadow}"/>
                                                        <Button Width="28" Height="28" FontFamily="Segoe MDL2 Assets" FontSize="14" Content="" ToolTip="Delete"
                                                                Command="{Binding DataContext.RemoveMovieCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                CommandParameter="{Binding}"
                                                                Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=False}"
                                                                Background="#F44336" Foreground="White" BorderBrush="Black" BorderThickness="1.5" Margin="0,0,0,0"
                                                                Effect="{StaticResource IconShadow}"/>
                                                        <Button Width="28" Height="28" FontFamily="Segoe MDL2 Assets" FontSize="14" Content="" ToolTip="Save"
                                                                Command="{Binding DataContext.SaveMovieCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                CommandParameter="{Binding}"
                                                                Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}}"
                                                                Background="#4CAF50" Foreground="White" BorderBrush="Black" BorderThickness="1.5" Margin="0,0,4,0"
                                                                Effect="{StaticResource IconShadow}"/>
                                                        <Button Width="28" Height="28" FontFamily="Segoe MDL2 Assets" FontSize="14" Content="" ToolTip="Undo"
                                                                Command="{Binding DataContext.UndoMovieCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                CommandParameter="{Binding}"
                                                                Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}}"
                                                                Background="#FFC107" Foreground="White" BorderBrush="Black" BorderThickness="1.5" Margin="0,0,0,0"
                                                                Effect="{StaticResource IconShadow}"/>
                                                    </StackPanel>
                                                </Border>
                                           </StackPanel>
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>
    </Grid>
</UserControl>
